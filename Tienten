-- StarterPlayerScripts/AutoFarmCandyGift.client.lua

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

local enabled = false
local SCAN_INTERVAL = 0.25      -- how often to rescan
local TELEPORT_HEIGHT = 6       -- studs above target
local STUCK_RETRY_TIME = 2.0    -- if target doesn't disappear, switch target after this

local TARGET_NAMES = { Candy = true, Gift = true }

local function getChar()
	return player.Character or player.CharacterAdded:Wait()
end

local function getHRP()
	local char = getChar()
	return char:WaitForChild("HumanoidRootPart", 5)
end

local function getPivotCF(inst: Instance): CFrame?
	local ok, cf = pcall(function()
		if inst and inst.GetPivot then
			return inst:GetPivot()
		end
		return nil
	end)
	return (ok and cf) or nil
end

local function isValidTarget(inst: Instance): boolean
	if not inst or not inst.Parent then return false end
	if not TARGET_NAMES[inst.Name] then return false end
	return inst:IsA("Model") or inst:IsA("BasePart")
end

local function distanceTo(inst: Instance, fromPos: Vector3): number
	local cf = getPivotCF(inst)
	if not cf then return math.huge end
	return (cf.Position - fromPos).Magnitude
end

local function getAllTargets()
	local targets = {}
	for _, inst in ipairs(workspace:GetChildren()) do
		if isValidTarget(inst) then
			table.insert(targets, inst)
		end
	end
	return targets
end

local function getClosestTarget()
	local hrp = getHRP()
	if not hrp then return nil end

	local best, bestDist = nil, math.huge
	for _, inst in ipairs(getAllTargets()) do
		local d = distanceTo(inst, hrp.Position)
		if d < bestDist then
			bestDist = d
			best = inst
		end
	end
	return best
end

local function teleportTo(inst: Instance)
	local cf = getPivotCF(inst)
	if not cf then return end
	getChar():PivotTo(cf + Vector3.new(0, TELEPORT_HEIGHT, 0))
end

-- Main farming loop
task.spawn(function()
	while true do
		-- Idle when disabled
		while not enabled do
			task.wait(0.2)
		end

		local target = getClosestTarget()
		if not target then
			-- nothing to farm
			task.wait(SCAN_INTERVAL)
			continue
		end

		-- Teleport to chosen target
		teleportTo(target)

		-- Wait until target is gone (collected) OR we give up and pick another
		local start = os.clock()
		while enabled and target and target.Parent do
			-- if it takes too long, break and pick another (prevents getting stuck)
			if os.clock() - start > STUCK_RETRY_TIME then
				break
			end
			RunService.Heartbeat:Wait()
		end

		task.wait(0.05)
	end
end)

-- ===== GUI =====
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmGUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 270, 0, 130)
frame.Position = UDim2.new(0, 20, 0, 120)
frame.Parent = gui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 24)
title.Position = UDim2.new(0, 10, 0, 8)
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left
title.Text = "Auto Farm (Candy/Gift)"
title.Parent = frame

local toggle = Instance.new("TextButton")
toggle.Size = UDim2.new(1, -20, 0, 44)
toggle.Position = UDim2.new(0, 10, 0, 38)
toggle.Text = "OFF"
toggle.Parent = frame

local status = Instance.new("TextLabel")
status.Size = UDim2.new(1, -20, 0, 40)
status.Position = UDim2.new(0, 10, 0, 88)
status.BackgroundTransparency = 1
status.TextXAlignment = Enum.TextXAlignment.Left
status.Text = "Disabled"
status.TextWrapped = true
status.Parent = frame

local function refresh()
	toggle.Text = enabled and "ON" or "OFF"
	status.Text = enabled and "Enabled: scanning workspace and teleporting until none left." or "Disabled"
end

toggle.MouseButton1Click:Connect(function()
	enabled = not enabled
	refresh()
end)

refresh()
