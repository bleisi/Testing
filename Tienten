-- StarterPlayerScripts/AutoFarmCandyGift.client.lua

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

local enabled = false

local SCAN_INTERVAL = 0.25      -- seconds between scans
local TELEPORT_HEIGHT = 6       -- studs above target
local SWITCH_AFTER = 2.0        -- if target doesn't disappear, switch
local MIN_TP_INTERVAL = 0.12    -- avoid spamming teleport

local TARGET_NAMES = { Candy = true, Gift = true }

local lastTpTime = 0

local function getChar()
	return player.Character or player.CharacterAdded:Wait()
end

local function getHRP()
	local char = getChar()
	return char:WaitForChild("HumanoidRootPart", 5)
end

local function getPivotCF(inst: Instance): CFrame?
	-- Works for Model/BasePart (PVInstances)
	local ok, cf = pcall(function()
		if inst and inst.GetPivot then
			return inst:GetPivot()
		end
		return nil
	end)
	return (ok and cf) or nil
end

local function isTarget(inst: Instance): boolean
	if not inst or not inst.Parent then return false end
	if not TARGET_NAMES[inst.Name] then return false end
	return inst:IsA("Model") or inst:IsA("BasePart")
end

local function teleportTo(inst: Instance)
	local now = os.clock()
	if now - lastTpTime < MIN_TP_INTERVAL then return end
	lastTpTime = now

	local cf = getPivotCF(inst)
	if not cf then return end
	getChar():PivotTo(cf + Vector3.new(0, TELEPORT_HEIGHT, 0))
end

local function findClosestTarget(): Instance?
	local hrp = getHRP()
	if not hrp then return nil end
	local origin = hrp.Position

	local best, bestDist = nil, math.huge

	-- IMPORTANT: only direct children (fast + low allocations)
	for _, inst in ipairs(workspace:GetChildren()) do
		if isTarget(inst) then
			local cf = getPivotCF(inst)
			if cf then
				local d = (cf.Position - origin).Magnitude
				if d < bestDist then
					bestDist = d
					best = inst
				end
			end
		end
	end

	return best
end

-- Main loop (single thread, no accumulating connections)
task.spawn(function()
	while true do
		if not enabled then
			task.wait(0.2)
		else
			local target = findClosestTarget()
			if not target then
				task.wait(SCAN_INTERVAL)
			else
				teleportTo(target)

				-- Wait until it disappears, or switch if it doesn't
				local start = os.clock()
				while enabled and target.Parent do
					if os.clock() - start > SWITCH_AFTER then
						break
					end
					RunService.Heartbeat:Wait()
				end

				task.wait(0.05)
			end
		end
	end
end)

-- ===== GUI =====
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmGUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 270, 0, 130)
frame.Position = UDim2.new(0, 20, 0, 120)
frame.Parent = gui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 24)
title.Position = UDim2.new(0, 10, 0, 8)
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left
title.Text = "Auto Farm (Candy/Gift)"
title.Parent = frame

local toggle = Instance.new("TextButton")
toggle.Size = UDim2.new(1, -20, 0, 44)
toggle.Position = UDim2.new(0, 10, 0, 38)
toggle.Text = "OFF"
toggle.Parent = frame

local status = Instance.new("TextLabel")
status.Size = UDim2.new(1, -20, 0, 40)
status.Position = UDim2.new(0, 10, 0, 88)
status.BackgroundTransparency = 1
status.TextXAlignment = Enum.TextXAlignment.Left
status.TextWrapped = true
status.Text = "Disabled"
status.Parent = frame

local function refresh()
	toggle.Text = enabled and "ON" or "OFF"
	status.Text = enabled and "Enabled: teleports until none left." or "Disabled"
end

toggle.MouseButton1Click:Connect(function()
	enabled = not enabled
	refresh()
end)

refresh()
