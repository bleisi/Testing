--// ONE GUI - TWO TOGGLES (FINAL MERGED + EndGame reset/auto upboard after 5s)
-- Put this LocalScript in StarterPlayerScripts

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local Remotes = ReplicatedStorage:WaitForChild("Remotes")
local MoneyRemote = Remotes:WaitForChild("Money")
local ChampionRemote = Remotes:WaitForChild("Champion")
local UpboardRemote = Remotes:WaitForChild("Upboard")

-- ===================== CONFIG =====================
local thresholds = {975, 1150, 1725, 2010, 2530, 2750}
local PRESET_ATTRIBUTE_KEY = "Champion"
local PRESET_ATTRIBUTE_VALUE = "Blade Master" -- change if needed (e.g. "blademaster")

local UPBOARD_COOLDOWN = 0.75
local ENDGAME_DELAY = 5

-- ===================== HELPERS =====================
local function norm(v)
	return tostring(v or ""):lower():gsub("%s+", "")
end

-- ===================== FEATURE 1: AUTO UPGRADE PRESET =====================
local autoUpgradeEnabled = false
local currentMoney = 0
local nextIndex = 1
local upgradeBusy = false

local function findTargetPreset()
	local presets = Workspace:WaitForChild("Presets")
	local wantVal = norm(PRESET_ATTRIBUTE_VALUE)

	for _, preset in ipairs(presets:GetChildren()) do
		local attr = preset:GetAttribute(PRESET_ATTRIBUTE_KEY)
		if attr ~= nil and norm(attr) == wantVal then
			return preset
		end
	end
	return nil
end

local function fireUpgradePreset()
	local preset = findTargetPreset()
	if not preset then
		return false, "Upgrade: Preset not found"
	end
	ChampionRemote:FireServer("Upgrade", preset)
	return true, "Upgrade: Sent Upgrade"
end

local function processUpgrades(updateUIFn)
	if not autoUpgradeEnabled then return end
	if upgradeBusy then return end
	if nextIndex > #thresholds then return end

	upgradeBusy = true

	while autoUpgradeEnabled
		and nextIndex <= #thresholds
		and (currentMoney + 1e-6) >= thresholds[nextIndex]
	do
		local target = thresholds[nextIndex]
		if updateUIFn then updateUIFn(("Upgrade: Upgrading @ %d..."):format(target)) end

		local ok, msg = fireUpgradePreset()
		if not ok then
			if updateUIFn then updateUIFn(msg) end
			break
		end

		nextIndex += 1
		task.wait(0.25)
	end

	upgradeBusy = false
end

-- ===================== FEATURE 2: AUTO UPBOARD (LOOP + ENDGAME TRIGGER) =====================
local autoUpboardEnabled = false
local upboardLastAction = nil
local upboardLastFireAt = 0

local function tryGetPlayAgainHolder()
	local upboard = playerGui:FindFirstChild("Upboard")
	if not upboard then return nil end
	local result = upboard:FindFirstChild("Result")
	if not result then return nil end
	local main = result:FindFirstChild("Main")
	if not main then return nil end
	local options = main:FindFirstChild("Options")
	if not options then return nil end
	return options:FindFirstChild("PlayAgainButtonHolder")
end

local function desiredUpboardAction(holder)
	if not holder then return nil end
	return holder.Visible and "PlayAgain" or "Leave"
end

local function fireUpboardAction(action, updateUIFn, force)
	if not action then return end

	local now = os.clock()
	if not force then
		if now - upboardLastFireAt < UPBOARD_COOLDOWN then return end
		if action == upboardLastAction then return end
	end

	upboardLastAction = action
	upboardLastFireAt = now

	UpboardRemote:FireServer(action)
	if updateUIFn then updateUIFn(("Upboard: Sent %s"):format(action)) end
end

local function startUpboardLoop(updateUIFn, setVisibleLabelFn)
	task.spawn(function()
		while true do
			if autoUpboardEnabled then
				local holder = tryGetPlayAgainHolder()
				local action = desiredUpboardAction(holder)

				if setVisibleLabelFn then
					setVisibleLabelFn(holder and holder.Visible or nil)
				end

				fireUpboardAction(action, updateUIFn, false)
			end
			task.wait(0.2)
		end
	end)
end

-- EndGame handler: reset upgrades + wait 5s + force upboard action (restart/leave)
local endGameTaskId = 0
local function handleEndGame(updateUIFn, setVisibleLabelFn)
	endGameTaskId += 1
	local myId = endGameTaskId

	-- Reset upgrades
	nextIndex = 1
	upgradeBusy = false
	if updateUIFn then updateUIFn("Upgrade: Reset (EndGame)") end

	task.delay(ENDGAME_DELAY, function()
		if myId ~= endGameTaskId then return end

		-- Try to get holder (it may appear after delay)
		local holder = tryGetPlayAgainHolder()
		if setVisibleLabelFn then
			setVisibleLabelFn(holder and holder.Visible or nil)
		end

		local tries = 0
		while (not holder) and tries < 20 do
			task.wait(0.25)
			holder = tryGetPlayAgainHolder()
			tries += 1
			if setVisibleLabelFn then
				setVisibleLabelFn(holder and holder.Visible or nil)
			end
		end

		local action
		if holder then
			action = holder.Visible and "PlayAgain" or "Leave"
		else
			action = "Leave" -- fallback
		end

		-- Force fire (ignore lastAction/cooldown)
		upboardLastAction = nil
		upboardLastFireAt = 0
		fireUpboardAction(action, updateUIFn, true)
	end)
end

-- ===================== ONE GUI =====================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "VIP_MultiAutoGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 340, 0, 210)
frame.Position = UDim2.new(0, 20, 0.5, -105)
frame.BackgroundColor3 = Color3.fromRGB(25, 25, 28)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 0, 24)
title.Position = UDim2.new(0, 10, 0, 8)
title.BackgroundTransparency = 1
title.Text = "VIP Auto Panel (2 Toggles)"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

-- Upgrade section
local upgradeStatus = Instance.new("TextLabel")
upgradeStatus.Size = UDim2.new(1, -20, 0, 18)
upgradeStatus.Position = UDim2.new(0, 10, 0, 38)
upgradeStatus.BackgroundTransparency = 1
upgradeStatus.Text = "Upgrade: OFF"
upgradeStatus.TextColor3 = Color3.fromRGB(200, 200, 200)
upgradeStatus.Font = Enum.Font.Gotham
upgradeStatus.TextSize = 13
upgradeStatus.TextXAlignment = Enum.TextXAlignment.Left
upgradeStatus.Parent = frame

local moneyLabel = Instance.new("TextLabel")
moneyLabel.Size = UDim2.new(1, -20, 0, 18)
moneyLabel.Position = UDim2.new(0, 10, 0, 58)
moneyLabel.BackgroundTransparency = 1
moneyLabel.Text = "Money: 0"
moneyLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
moneyLabel.Font = Enum.Font.Gotham
moneyLabel.TextSize = 13
moneyLabel.TextXAlignment = Enum.TextXAlignment.Left
moneyLabel.Parent = frame

local nextLabel = Instance.new("TextLabel")
nextLabel.Size = UDim2.new(1, -20, 0, 18)
nextLabel.Position = UDim2.new(0, 10, 0, 78)
nextLabel.BackgroundTransparency = 1
nextLabel.Text = "Next: 975"
nextLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
nextLabel.Font = Enum.Font.Gotham
nextLabel.TextSize = 13
nextLabel.TextXAlignment = Enum.TextXAlignment.Left
nextLabel.Parent = frame

local presetLabel = Instance.new("TextLabel")
presetLabel.Size = UDim2.new(1, -20, 0, 18)
presetLabel.Position = UDim2.new(0, 10, 0, 98)
presetLabel.BackgroundTransparency = 1
presetLabel.Text = "Preset: (searching...)"
presetLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
presetLabel.Font = Enum.Font.Gotham
presetLabel.TextSize = 12
presetLabel.TextXAlignment = Enum.TextXAlignment.Left
presetLabel.Parent = frame

-- Upboard section
local upboardStatus = Instance.new("TextLabel")
upboardStatus.Size = UDim2.new(1, -20, 0, 18)
upboardStatus.Position = UDim2.new(0, 10, 0, 128)
upboardStatus.BackgroundTransparency = 1
upboardStatus.Text = "Upboard: OFF"
upboardStatus.TextColor3 = Color3.fromRGB(200, 200, 200)
upboardStatus.Font = Enum.Font.Gotham
upboardStatus.TextSize = 13
upboardStatus.TextXAlignment = Enum.TextXAlignment.Left
upboardStatus.Parent = frame

local visibleLabel = Instance.new("TextLabel")
visibleLabel.Size = UDim2.new(1, -20, 0, 18)
visibleLabel.Position = UDim2.new(0, 10, 0, 148)
visibleLabel.BackgroundTransparency = 1
visibleLabel.Text = "PlayAgainButtonHolder.Visible: (waiting...)"
visibleLabel.TextColor3 = Color3.fromRGB(160, 160, 160)
visibleLabel.Font = Enum.Font.Gotham
visibleLabel.TextSize = 12
visibleLabel.TextXAlignment = Enum.TextXAlignment.Left
visibleLabel.Parent = frame

-- Buttons
local upgradeToggle = Instance.new("TextButton")
upgradeToggle.Size = UDim2.new(0.5, -15, 0, 34)
upgradeToggle.Position = UDim2.new(0, 10, 1, -44)
upgradeToggle.BackgroundColor3 = Color3.fromRGB(70, 70, 75)
upgradeToggle.BorderSizePixel = 0
upgradeToggle.Text = "Upgrade: OFF"
upgradeToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
upgradeToggle.Font = Enum.Font.GothamBold
upgradeToggle.TextSize = 14
upgradeToggle.Parent = frame

local upboardToggle = Instance.new("TextButton")
upboardToggle.Size = UDim2.new(0.5, -15, 0, 34)
upboardToggle.Position = UDim2.new(0.5, 5, 1, -44)
upboardToggle.BackgroundColor3 = Color3.fromRGB(70, 70, 75)
upboardToggle.BorderSizePixel = 0
upboardToggle.Text = "Upboard: OFF"
upboardToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
upboardToggle.Font = Enum.Font.GothamBold
upboardToggle.TextSize = 14
upboardToggle.Parent = frame

local c1 = Instance.new("UICorner")
c1.CornerRadius = UDim.new(0, 10)
c1.Parent = upgradeToggle

local c2 = Instance.new("UICorner")
c2.CornerRadius = UDim.new(0, 10)
c2.Parent = upboardToggle

-- UI functions
local function setVisibleLabel(v)
	if v == nil then
		visibleLabel.Text = "PlayAgainButtonHolder.Visible: (waiting...)"
	else
		visibleLabel.Text = "PlayAgainButtonHolder.Visible: " .. tostring(v)
	end
end

local function updateUI(statusText)
	moneyLabel.Text = ("Money: %d"):format(math.floor(currentMoney + 0.5))
	local nextTarget = thresholds[nextIndex]
	nextLabel.Text = nextTarget and ("Next: %d"):format(nextTarget) or "Next: DONE"

	local preset = findTargetPreset()
	presetLabel.Text = ("Preset: %s"):format(preset and preset.Name or "(not found)")

	upgradeToggle.Text = autoUpgradeEnabled and "Upgrade: ON" or "Upgrade: OFF"
	upgradeToggle.BackgroundColor3 = autoUpgradeEnabled and Color3.fromRGB(0, 170, 85) or Color3.fromRGB(70, 70, 75)

	upboardToggle.Text = autoUpboardEnabled and "Upboard: ON" or "Upboard: OFF"
	upboardToggle.BackgroundColor3 = autoUpboardEnabled and Color3.fromRGB(0, 170, 85) or Color3.fromRGB(70, 70, 75)

	if statusText then
		if statusText:sub(1, 7) == "Upgrade" then
			upgradeStatus.Text = statusText
		elseif statusText:sub(1, 6) == "Upboard" then
			upboardStatus.Text = statusText
		end
	else
		upgradeStatus.Text = autoUpgradeEnabled and "Upgrade: ON" or "Upgrade: OFF"
		upboardStatus.Text = autoUpboardEnabled and "Upboard: ON" or "Upboard: OFF"
	end
end

-- ===================== EVENTS =====================
MoneyRemote.OnClientEvent:Connect(function(action, amount)
	if action ~= "Update" then return end
	currentMoney = tonumber(amount) or 0
	updateUI()
	processUpgrades(updateUI)
end)

upgradeToggle.MouseButton1Click:Connect(function()
	autoUpgradeEnabled = not autoUpgradeEnabled
	updateUI()
	processUpgrades(updateUI)
end)

upboardToggle.MouseButton1Click:Connect(function()
	autoUpboardEnabled = not autoUpboardEnabled
	if autoUpboardEnabled then
		-- allow immediate action when turning ON
		upboardLastAction = nil
		upboardLastFireAt = 0
	end
	updateUI()
end)

-- Listen for EndGame signal from server -> reset upgrades and force upboard after 5s
UpboardRemote.OnClientEvent:Connect(function(action, ...)
	if action == "EndGame" then
		handleEndGame(updateUI, setVisibleLabel)
	end
end)

-- Start upboard loop once (it will only act when toggle ON)
startUpboardLoop(updateUI, setVisibleLabel)

updateUI()
